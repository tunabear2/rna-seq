install.packages("WGCNA")

library(DESeq2)
library(tximport)
library(WGCNA)
options(stringsAsFactors = FALSE)
allowWGCNAThreads()


rsem_dir <- "/Users/dwyun/rsem/data"   # ← rsem .genes.results 파일들이 있는 폴더

# .genes.results 파일 목록
files <- list.files(rsem_dir,
                    pattern = "\\.genes\\.results$",
                    full.names = TRUE)
stopifnot(length(files) > 1)

# sample 이름 = 파일명에서 .genes.results 제거한 것
samples <- sub("\\.genes\\.results$", "", basename(files))
names(files) <- samples

samples

condition <- dplyr::case_when(
  grepl("prom1_TdT_TW", samples) ~ "prom1_TdT_TW",
  grepl("prom1_TdT",     samples) ~ "prom1_TdT",
  grepl("TdT_TW",        samples) ~ "TdT_TW",
  grepl("TdT",           samples) ~ "TdT",
  TRUE ~ "unknown"
)

condition <- factor(
  condition,
  levels = c("prom1_TdT_TW", "TdT_TW", "prom1_TdT", "TdT")  # 순서는 원하는대로 조정
)

coldata <- data.frame(
  sample    = samples,
  condition = condition,
  row.names = samples
)

coldata

txi <- tximport(
  files,
  type = "rsem",
  txIn = FALSE,
  txOut = FALSE,
  countsFromAbundance = "no"
)

# 길이가 0인 유전자는 에러 방지용으로 1로 교체
txi$length[txi$length == 0] <- 1

dds <- DESeqDataSetFromTximport(
  txi     = txi,
  colData = coldata,
  design  = ~ condition
)

dds <- DESeq(dds)

# vst 변환 (WGCNA용 expression 값)
vsd <- vst(dds, blind = FALSE)
expr_mat <- assay(vsd)   # genes x samples

dim(expr_mat)

library(matrixStats)

gene_var <- rowVars(expr_mat)

gene_var

n_keep <- min(5000, nrow(expr_mat))

keep_genes_idx <- order(gene_var, decreasing = TRUE)[1:n_keep]
keep_genes_idx

expr_filt <- expr_mat[keep_genes_idx, ]
expr_filt

datExpr <- t(expr_filt)

gsg <- goodSamplesGenes(datExpr, verbose = 3)
gsg$allOK

powers <- c(1:30)

sft <- pickSoftThreshold(
  datExpr,
  powerVector = powers,
  networkType = "signed",
  verbose = 5
)

softPower <- sft$powerEstimate
if (is.na(softPower)) {
  softPower <- 6
}
softPower

cor <- WGCNA::cor
net <- blockwiseModules(
  datExpr,
  power = softPower,
  networkType = "signed",
  TOMType = "signed",
  minModuleSize = 30,
  reassignThreshold = 0,
  mergeCutHeight = 0.25,
  numericLabels = TRUE,
  pamRespectsDendro = FALSE,
  saveTOMs = FALSE,
  verbose = 3
)

moduleLabels <- net$colors
moduleColors <- labels2colors(moduleLabels)
MEs <- net$MEs
geneTree <- net$dendrograms[[1]]

plotDendroAndColors(
  geneTree,
  moduleColors,
  "module colors",
  dendroLabels = FALSE,
  hang = 0.03,
  addGuide = TRUE,
  guideHang = 0.05
)

datTraits <- data.frame(
  condition = coldata$condition
)
rownames(datTraits) <- rownames(coldata)

datTraits <- datTraits[rownames(datExpr), , drop = FALSE]

MEs0 <- moduleEigengenes(datExpr, moduleColors)$eigengenes
MEs <- orderMEs(MEs0)

traitDesign <- model.matrix(~ 0 + condition, data = datTraits)
colnames(traitDesign) <- gsub("condition", "", colnames(traitDesign))
traitDesign

moduleTraitCor <- cor(MEs, traitDesign, use = "p")
moduleTraitPvalue <- corPvalueStudent(moduleTraitCor, nrow(datExpr))

textMatrix <- paste0(
  signif(moduleTraitCor, 2), "\n(",
  signif(moduleTraitPvalue, 1), ")"
)
dim(textMatrix) <- dim(moduleTraitCor)

png("module_trait_heatmap.png",
    width = 1600, height = 1000,
    res = 150)
par(mar = c(6, 8.5, 3, 3))
labeledHeatmap(
  Matrix = moduleTraitCor,
  xLabels = colnames(traitDesign),
  yLabels = names(MEs),
  ySymbols = names(MEs),
  colorLabels = FALSE,
  colors = blueWhiteRed(50),
  textMatrix = textMatrix,
  setStdMargins = FALSE,
  cex.text = 0.7,
  zlim = c(-1, 1),
  main = "module-condition relationships\ncor (p-value)"
)
dev.off()

table(moduleColors)
gene_names <- colnames(datExpr)
gene_modules <- data.frame(
  gene = gene_names,
  module = moduleColors,
  stringsAsFactors = FALSE
)

map_orgdb <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys    = unique(gene_modules$gene),
  keytype = "ENSEMBL",
  columns = c("SYMBOL", "ENTREZID")
) %>% 
  dplyr::distinct(ENSEMBL, .keep_all = TRUE)

gene_modules <- gene_modules %>%
  dplyr::left_join(map_orgdb, by = c("gene" = "ENSEMBL"))

gene_modules <- gene_modules %>%
  mutate(
    SYMBOL = coalesce(na_if(SYMBOL, ""), gene),
    ENTREZID = coalesce(na_if(as.character(ENTREZID), ""), gene)
  )

gene_modules <- gene_modules %>%
  dplyr::select(gene, SYMBOL, ENTREZID, everything())

write.csv(gene_modules,
          file = "WGCNA_gene_modules.csv",
          row.names = FALSE)
brown_genens <- subset(gene_modules, module == "brown")$SYMBOL
brown_genens_df <- data.frame(
  gene = brown_genens,
  stringsAsFactors = FALSE
)
write.csv(
  brown_genens_df,
  file = "brown_genes.csv",
  row.names = FALSE
)
