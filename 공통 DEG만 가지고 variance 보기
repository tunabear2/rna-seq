library(readxl)
library(dplyr)

# 6개 파일 이름 (네 파일 이름으로 바꿔줘!)
deg_list <- list(
  S1_vs_S2_sig_genes,
  S1_vs_S3_sig_genes,
  S1_vs_S4_sig_genes,
  S2_vs_S3_sig_genes,
  S2_vs_S4_sig_genes,
  S3_vs_S4_sig_genes
)

deg_all <- bind_rows(deg_list, .id = "contrast")  # contrast 열에 S1_vs_S2 등 출처 정보까지 들어감

dim(deg_all)   # 전체 row가 몇 개인지 확인

# 모든 비교에서 등장한 gene_id들의 union
deg_genes <- unique(deg_all$gene_id)

length(deg_genes)  # DEG gene이 총 몇 개인지 확인

# expr_mat의 rownames 기준으로 DEG gene 중 실제로 있는 것 / 없는 것 나눠보기
present_deg_genes <- deg_genes[deg_genes %in% rownames(expr_mat)]
missing_deg_genes <- setdiff(deg_genes, rownames(expr_mat))

length(present_deg_genes)  # expr_mat 안에 존재하는 DEG 수
length(missing_deg_genes)  # 빠진 gene 수 (참고용)

# DEG gene만 남긴 expression matrix (genes × samples)
expr_deg <- expr_mat[present_deg_genes, , drop = FALSE]

dim(expr_deg)  # [DEG gene 수, 샘플 수]

library(matrixStats)

deg_gene_var <- rowVars(expr_deg)
names(deg_gene_var) <- rownames(expr_deg)

# 요약
summary(deg_gene_var)
head(sort(deg_gene_var, decreasing = TRUE))

df_deg_var <- data.frame(
  gene_id = rownames(expr_deg),
  var = deg_gene_var
)

ggplot(df_deg_var, aes(x = var)) +
  geom_histogram(bins = 100) +
  scale_x_log10() +
  labs(
    x = "Variance(log10 scale) (DEG genes only)",
    y = "Gene count(1898)",
    title = "Distribution of gene-wise variance (DEG set)"
  )

datExpr_deg <- t(expr_deg)   # samples × genes

# 이후 과정은 전에 했던 WGCNA 코드에서 datExpr만 바꿔 끼우면 됨
gsg <- goodSamplesGenes(datExpr_deg, verbose = 3)
gsg$allOK
