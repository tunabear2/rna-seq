# DESeq2 사용을 위해 RSTUDIO 설치하기
# Rtools 다운로드 하기
https://cran.r-project.org/bin/windows/Rtools/
R 버전에 맞게 다운로드

# R에서 진행

install.packages("BiocManager") # 패키지 설치

# Bioconductor의 core packages 설치
BiocManager::install("DESeq2") #DESeq2 패키지 설치
BiocManager::install("tximport") # rsem을 통해 생성된 데이터를 DESeq2 분석을 위한 table 데이터로 바꾸는 tool
BiocManager::install("readr") # 나중에 csv 생성을 위한 tool

install.packages("ggplot2")
install.packages("dplyr")
install.packages("tibble")

library(DESeq2)
library(dplyr)
library(tibble)
library(ggplot2)
library(tximport)
library(readr)

# Sample 경로 만들기.
samples <- c("SRR1039508","SRR1039509","SRR1039512","SRR1039513","SRR1039516","SRR1039517","SRR1039520","SRR1039521")
files <- file.path("result/rsem", paste0(samples, ".genes.results"))
names(files) <- samples
# gene-Level RSEM 파일 불러오기
txi <- txiport(files, type = "rsem", txIn = FALSE, txOut = FALSE)
# 1) count matrix 불러오기
counts <- read.csv("gene_counts.csv", row.names=1)   # 첫 열에 gene ID
# 2) 메타데이터 불러오기 (조건 정보)
coldata <- read.csv("sample_info.csv", row.names=1) # sampleID와 condition 포함

# 3) DESeq2 객체 생성
dds <- DESeqDataSetFromMatrix(countData = counts,
                              colData = coldata,
                              design = ~ condition)

# 4) normalization 및 DE 분석
dds <- DESeq(dds)
res <- results(dds)   # 기본 비교 (예: treatment vs control)

# 5) 결과 저장
resOrdered <- res[order(res$pvalue), ]
write.csv(as.data.frame(resOrdered), file="DEG_results.csv")
# log2FoldChange vs -log10(p-value)
res$logP <- -log10(res$padj)

ggplot(res, aes(x=log2FoldChange, y=logP)) +
  geom_point(alpha=0.4) +
  geom_vline(xintercept=c(-1, 1), col="red", linetype="dashed") +
  geom_hline(yintercept=-log10(0.05), col="blue", linetype="dashed") +
  theme_minimal()

library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = counts_f, colData = coldata, design = ~ condition)

# 많은 zero/구성편향이 우려되면 'poscounts' 추천
dds <- estimateSizeFactors(dds, type = "poscounts")  # 기본은 "ratio"
sizeFactors(dds)  # 샘플별 라이브러리 크기 보정계수
